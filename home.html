<!DOCTYPE html>
<html lang="en-AU">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark" />
  <title>Home — Art Online by Jody Graham</title>

  <style>
    :root{
      --ink:#eef3ff; --muted:rgba(238,243,255,.78); --greyText:#cfd3e1;
      --stroke:rgba(255,255,255,.18); --surface:#000; /* SOLID BLACK HEROES */
      --blue:#0A84FF; --green:#32d74b; --gold:#ffd700; --red:#ff453a; --pink:#ff2d55;
      --r-lg:16px; --r-md:12px; --gap:12px; --maxw:1200px;
      --nav-h:64px; --tabs-h:56px; --chrome-h: calc(var(--nav-h) + var(--tabs-h) + 24px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
      background:#000;
      -webkit-user-select:none; user-select:none;       /* deter copy */
      -webkit-touch-callout:none;
    }
    a{color:inherit; text-decoration:none}
    img{pointer-events:none; -webkit-user-drag:none}
    body:focus-visible{outline:none}

    /* Fixed, full-bleed background that never moves */
    .bg{
      position:fixed; inset:0; z-index:-1;
      background:#000 url("./assets/home-bg.jpg") center center / cover no-repeat;
      /* Use a fixed layer element rather than background-attachment for iOS */
      will-change:transform;
    }

    /* Top Nav */
    .nav{position:fixed; top:0; left:0; right:0; height:var(--nav-h);
      display:flex; align-items:flex-start; justify-content:space-between; padding:8px 20px; z-index:10;
      background:linear-gradient(180deg, rgba(0,0,0,.7), transparent);
      -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px);
    }
    .logo-block{line-height:1.1}
    .logo-title{font-weight:900; letter-spacing:.2px; color:var(--blue)}
    .logo-sub{font-weight:700; color:#fff}
    .nav-actions{display:flex; align-items:center; gap:10px}
    .points-display{font-weight:800; background:rgba(0,0,0,.55); border:1px solid var(--stroke);
      border-radius:999px; padding:6px 10px}
    .avatar{width:34px; height:34px; border-radius:50%; border:1px solid var(--stroke);
      background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      display:grid; place-items:center; font-weight:900}
    .btn{padding:10px 14px; border-radius:12px; font-weight:700; border:0; cursor:pointer}
    .btn.primary{background:var(--blue); color:#fff}
    .btn.success{background:var(--green); color:#000; font-weight:900}
    .btn.warn{background:var(--gold); color:#000; font-weight:900}
    .btn.ghost{background:rgba(0,0,0,.55); border:1px solid var(--stroke); color:var(--ink)}
    .btn[disabled]{opacity:.55; cursor:not-allowed}

    .wrap{position:relative; z-index:1; padding:96px 20px 64px; max-width:var(--maxw); margin:0 auto}

    /* Tabs */
    .tabs{display:flex; gap:8px; padding:6px; margin:-8px 0 12px; position:sticky; top:var(--nav-h); z-index:5;
      justify-content:center; background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.35) 60%, transparent); border-radius:14px;
      -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px)}
    .tab{padding:10px 14px; border-radius:999px; border:1px solid var(--stroke); background:rgba(0,0,0,.55); color:var(--ink); font-weight:700; cursor:pointer}
    .tab.is-active{background:var(--blue); color:#fff; border-color:transparent}
    .tab-panel{display:none; animation:fade .2s ease} .tab-panel.is-active{display:block}
    @keyframes fade{from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:none}}

    /* Heroes (SOLID BLACK) */
    .hero{position:relative; overflow:hidden; border-radius:var(--r-lg); border:1px solid var(--stroke); background:var(--surface); min-height:220px; margin:12px 0}
    .hero-body{position:relative; z-index:1; padding:16px; display:flex; flex-direction:column; gap:8px; height:100%}
    .hero-title{margin:0; font-size:18px; font-weight:900}
    .hero-meta{margin:0; color:var(--greyText); font-size:.92rem}
    .hero-desc{margin:0; color:var(--muted)}
    .padlock{width:20px; height:20px; vertical-align:-3px; margin-right:6px; color:var(--ink)} /* padlock = hero text colour */

    /* Daily banner (full-width) */
    .hero-banner{height: clamp(260px, calc((100dvh - var(--chrome-h)) * 0.52), 440px); display:flex; align-items:flex-end}
    .expire-chip{display:inline-flex; gap:6px; align-items:center; border:1px solid var(--stroke); padding:6px 10px; border-radius:999px; background:rgba(0,0,0,.55); color:var(--ink)}
    .hero-cta{position:absolute; right:16px; bottom:16px; z-index:2}
    .btn-complete{min-width:140px; min-height:56px; border-radius:12px; background:var(--blue); color:#fff; font-weight:900}
    .btn-undo{min-width:140px; min-height:56px; border-radius:12px; background:#3a3a3a; color:#fff; font-weight:900}
    .is-complete{box-shadow:0 0 0 3px var(--green) inset}
    .is-complete .hero-title::after{content:"  ✓ Complete"; color:var(--green); font-weight:900; margin-left:6px}

    /* Weekly (3 across; stack in portrait) */
    .weekly-row{display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap); margin-top:12px; height: clamp(220px, calc((100dvh - var(--chrome-h)) * 0.40), 340px)}
    .weekly .hero-body{display:flex; flex-direction:column; gap:6px}
    .weekly .hero-expiry{position:absolute; right:16px; top:16px; font-size:.85rem; padding:6px 10px; border-radius:12px; background:rgba(0,0,0,.55); border:1px solid var(--stroke)}
    .weekly.is-expired{opacity:.7}

    /* Start buttons pinned bottom-left in weekly and courses */
    .btn-left{position:absolute; left:16px; bottom:16px}

    /* Courses */
    .grid{display:grid; gap:var(--gap); margin:12px 0}
    .grid-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    .tall-hero{min-height: clamp(220px, 26vh, 320px)}
    .course.locked .padlock{display:inline} .course:not(.locked) .padlock{display:none}
    .course.is-complete{box-shadow:0 0 0 3px var(--green) inset}
    /* Theme hint ring on spans via data-theme */
    .course[data-theme="pink"] .hero-title::before{content:""; display:inline-block; width:8px; height:8px; border-radius:50%; background:var(--pink); margin-right:8px}

    /* Modals */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.6); backdrop-filter:blur(6px); z-index:20}
    .modal.open{display:grid}
    .modal-content{background:#0f1116; border:1px solid var(--stroke); border-radius:12px; padding:18px; width:min(92vw, 560px); box-shadow:0 16px 42px rgba(0,0,0,.5)}
    .modal-actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .field{display:grid; gap:6px; margin-top:8px}
    .field input{padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:#0a0a0a; color:var(--ink)}

    /* Achievements */
    .achievements-summary{display:flex; align-items:center; gap:14px; flex-wrap:wrap; margin:10px 0}
    .badge{display:inline-grid; place-items:center; width:56px; height:56px; border-radius:50%;
      background:linear-gradient(135deg, rgba(10,132,255,.22), rgba(255,255,255,.04)); border:1px solid var(--stroke); font-weight:900}
    .history-list{list-style:none; padding:0; margin:8px 0}
    .history-item{padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; gap:10px; align-items:center}
    .pager{display:flex; gap:8px; margin-top:8px}

    /* Calendar (black) */
    #tab-calendar .calendar-wrap{background:#000; border:1px solid var(--stroke); border-radius:12px; padding:10px}
    .cal-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:8px}
    .tallies{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
    .tally{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--stroke); border-radius:999px; padding:6px 10px; cursor:pointer; background:#0a0a0a}
    .chip{width:10px; height:10px; border-radius:50%}
    .chip.blue{background:var(--blue)} .chip.green{background:#00c853} .chip.pink{background:var(--pink)} .chip.red{background:var(--red)} .chip.gold{background:var(--gold)}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{min-height:86px; border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:4px; position:relative; background:#0a0a0a; cursor:pointer}
    .cal-date{font-size:.82rem; color:var(--greyText)}
    .bar{height:10px; border-radius:6px; margin-top:4px; width:100%} /* edge-to-edge bars */
    .bar.blue{background:var(--blue)} .bar.green{background:#00c853} .bar.pink{background:var(--pink)} .bar.red{background:var(--red)} .bar.gold{background:var(--gold)}
    .kebab{height:4px; border-radius:6px; margin-top:6px; background:#8a8a8a}
    .span{position:absolute; left:4px; right:4px; bottom:3px; height:3px; border-radius:4px}
    .span.green{background:#00c853} .span.pink{background:var(--pink)} .span.red{background:var(--red)}

    /* Day-detail modal list */
    .day-list{max-height:300px; overflow:auto; border-top:1px solid rgba(255,255,255,.1); margin-top:8px; padding-top:8px}

    /* Portrait stacking */
    @media (orientation:portrait){
      .tabs{top:62px}
      .weekly-row{grid-template-columns:1fr; height:auto}
      .grid-3{grid-template-columns:1fr}
    }
  </style>
</head>

<body class="home-bg" oncontextmenu="return false">
  <div class="bg" aria-hidden="true"></div>

  <!-- ===== Top Nav ===== -->
  <header class="nav">
    <div class="logo-block">
      <div class="logo-title">Art Online</div>
      <div class="logo-sub">by Jody Graham</div>
    </div>
    <div class="nav-actions">
      <div id="pointsDisplay" class="points-display">Points: <span id="pointsValue">0</span></div>
      <button class="btn ghost" id="toggleSub" aria-pressed="false">Subscriber: <span id="subState">Off</span></button>
      <a class="avatar" href="profile.html" title="Profile (click to view)">JG</a>
    </div>
  </header>

  <main class="wrap">
    <!-- ===== Tabs ===== -->
    <nav class="tabs" role="tablist" aria-label="Primary">
      <button class="tab is-active" role="tab" aria-selected="true" aria-controls="tab-challenges" id="tabbtn-challenges">Challenges</button>
      <button class="tab" role="tab" aria-controls="tab-foundations" id="tabbtn-foundations">Foundations</button>
      <button class="tab" role="tab" aria-controls="tab-courses" id="tabbtn-courses">Courses</button>
      <button class="tab" role="tab" aria-controls="tab-live" id="tabbtn-live">Live</button>
      <button class="tab" role="tab" aria-controls="tab-achievements" id="tabbtn-achievements">Achievements</button>
      <button class="tab" role="tab" aria-controls="tab-calendar" id="tabbtn-calendar">My Calendar</button>
    </nav>

    <!-- ===== CHALLENGES ===== -->
    <section class="tab-panel is-active" id="tab-challenges" role="tabpanel" aria-labelledby="tabbtn-challenges">
      <!-- Daily -->
      <article class="hero hero-banner" id="dailyHero">
        <div class="hero-body">
          <div>
            <h2 class="hero-title" id="dailyTitle">Today’s Daily Challenge</h2>
            <p class="hero-meta">
              <span id="dailyDate"></span>
              &nbsp;•&nbsp;<span class="expire-chip">Expires in <span id="dailyExpires">--</span></span>
            </p>
            <p class="hero-desc" id="dailyDesc">A quick 15–20 minute warm-up. All instructions appear here.</p>
          </div>
          <div class="hero-cta">
            <button class="btn btn-complete" id="btnDailyAction">Complete</button>
          </div>
        </div>
      </article>

      <!-- Weekly (3 tiles, subscriber-only; no subscribe popup) -->
      <div class="weekly-row" id="weeklyRow" aria-label="Weekly Challenges"></div>
      <ul id="weeklyIndex" hidden></ul> <!-- hidden index of 52 weekly pages -->
    </section>

    <!-- ===== FOUNDATIONS (purchasable, not subscription-gated) ===== -->
    <section class="tab-panel" id="tab-foundations" role="tabpanel" aria-labelledby="tabbtn-foundations">
      <h2 class="section-title">Foundations</h2>
      <div class="grid grid-3">
        <article class="hero tall-hero course locked" data-course-id="found-setup" data-course-type="1day" data-course-days="1" data-link="course-found-setup.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Materials & Setup</h3>
            <p class="hero-desc">Paper, charcoal, inks, brushes, safety & layout.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="found-drawing" data-course-type="1day" data-course-days="1" data-link="course-found-drawing.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Drawing</h3>
            <p class="hero-desc">Line, tone, proportion, gesture, observation.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="found-painting" data-course-type="1day" data-course-days="1" data-link="course-found-painting.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Painting</h3>
            <p class="hero-desc">Surface prep, colour mixing, value structure, brushwork.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
      </div>
    </section>

    <!-- ===== COURSES ===== -->
    <section class="tab-panel" id="tab-courses" role="tabpanel" aria-labelledby="tabbtn-courses">
      <h2 class="section-title">Online Courses</h2>

      <h3 class="section-title">1-Day Intensives</h3>
      <div class="grid grid-3">
        <article class="hero tall-hero course locked" data-course-id="1d-gesture" data-course-type="1day" data-course-days="1" data-link="course-1d-gesture.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Gesture Drawing</h3>
            <p class="hero-desc">Fast, confident gestures.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="1d-ink" data-course-type="1day" data-course-days="1" data-link="course-1d-ink.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Ink Essentials</h3>
            <p class="hero-desc">Brush, pen, splash control.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="1d-charcoal" data-course-type="1day" data-course-days="1" data-link="course-1d-charcoal.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Charcoal Tonals</h3>
            <p class="hero-desc">Structure with light/dark.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
      </div>

      <h3 class="section-title">3-Day Courses <span class="hero-meta">Redeem: 500 points</span></h3>
      <div class="grid grid-3">
        <article class="hero tall-hero course locked" data-course-id="3d-portrait" data-course-type="3day" data-course-days="3" data-redeem="500" data-link="course-3d-portrait.html" data-theme="pink">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Portrait Sprint</h3>
            <p class="hero-desc">Planes, proportions, expression.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="3d-urban" data-course-type="3day" data-course-days="3" data-redeem="500" data-link="course-3d-urban.html" data-theme="pink">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Urban Sketching</h3>
            <p class="hero-desc">Perspective on location.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="3d-experimental" data-course-type="3day" data-course-days="3" data-redeem="500" data-link="course-3d-experimental.html" data-theme="pink">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Experimental Media</h3>
            <p class="hero-desc">Combine mediums without fear.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
      </div>

      <h3 class="section-title">30-Day Courses <span class="hero-meta">Redeem: 1500 points</span></h3>
      <div class="grid grid-3">
        <article class="hero tall-hero course locked" data-course-id="30d-draw" data-course-type="30day" data-course-days="30" data-redeem="1500" data-link="course-30d-draw.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Drawing Foundations</h3>
            <p class="hero-desc">Daily habit and core skills.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="30d-paint" data-course-type="30day" data-course-days="30" data-redeem="1500" data-link="course-30d-paint.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Paint with Confidence</h3>
            <p class="hero-desc">Colour, value, edges.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
        <article class="hero tall-hero course locked" data-course-id="30d-portrait" data-course-type="30day" data-course-days="30" data-redeem="1500" data-link="course-30d-portrait.html">
          <div class="hero-body">
            <h3 class="hero-title"><svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Expressive Portraits</h3>
            <p class="hero-desc">Structure plus spontaneity.</p>
            <a class="btn primary btn-left btnStartCourse">Start Course</a>
          </div>
        </article>
      </div>
    </section>

    <!-- ===== LIVE ===== -->
    <section class="tab-panel" id="tab-live" role="tabpanel" aria-labelledby="tabbtn-live">
      <h2 class="section-title">Live Demonstrations</h2>
      <div class="grid grid-3">
        <article class="hero tall-hero" data-live-id="live-1">
          <div class="hero-body">
            <h3 class="hero-title">Upcoming Demo #1</h3>
            <p class="hero-desc">Bookings create gold calendar entries; completion marks ✓ on this hero.</p>
            <a class="btn primary btn-left btnBookLive">Book Demo</a>
          </div>
        </article>
        <article class="hero tall-hero" data-live-id="live-2">
          <div class="hero-body">
            <h3 class="hero-title">Upcoming Demo #2</h3>
            <p class="hero-desc">Placeholder live session.</p>
            <a class="btn primary btn-left btnBookLive">Book Demo</a>
          </div>
        </article>
        <article class="hero tall-hero" data-live-id="live-3">
          <div class="hero-body">
            <h3 class="hero-title">Upcoming Demo #3</h3>
            <p class="hero-desc">Placeholder live session.</p>
            <a class="btn primary btn-left btnBookLive">Book Demo</a>
          </div>
        </article>
      </div>
    </section>

    <!-- ===== ACHIEVEMENTS ===== -->
    <section class="tab-panel" id="tab-achievements" role="tabpanel" aria-labelledby="tabbtn-achievements">
      <h2 class="section-title">Achievements</h2>
      <div class="achievements-summary">
        <div class="points-display">Points: <span id="achPoints">0</span></div>
        <div id="streakDisplay" class="hero-meta"></div>
      </div>

      <h3 class="section-title">Weekly Badges</h3>
      <div id="badgesGrid"></div>

      <h3 class="section-title">Daily Completions</h3>
      <div id="dailyTicks"></div>

      <h3 class="section-title">History</h3>
      <ul id="historyList" class="history-list"></ul>
      <div class="pager">
        <button class="btn ghost" id="prevPage">Prev</button>
        <button class="btn ghost" id="nextPage">Next</button>
      </div>
    </section>

    <!-- ===== MY CALENDAR ===== -->
    <section class="tab-panel" id="tab-calendar" role="tabpanel" aria-labelledby="tabbtn-calendar">
      <h2 class="section-title">My Calendar</h2>

      <div class="tallies">
        <div class="tally" data-tally="daily"><span class="chip blue"></span> Daily (<span id="tallyDaily">0</span>)</div>
        <div class="tally" data-tally="weekly"><span class="chip green"></span> Weekly (<span id="tallyWeekly">0</span>)</div>
        <div class="tally" data-tally="3day"><span class="chip pink"></span> 3-Day (<span id="tally3d">0</span>)</div>
        <div class="tally" data-tally="30day"><span class="chip red"></span> 30-Day (<span id="tally30d">0</span>)</div>
        <div class="tally" data-tally="live"><span class="chip gold"></span> Live (<span id="tallyLive">0</span>)</div>
      </div>

      <div id="tallyLists" class="history-list" style="max-height:180px; overflow:auto; display:none"></div>

      <div class="calendar-wrap">
        <div class="cal-head">
          <button class="btn ghost" id="calPrev">◀</button>
          <div id="calTitle"></div>
          <button class="btn ghost" id="calNext">▶</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
      </div>
    </section>
  </main>

  <!-- ===== Modals ===== -->
  <!-- Purchase (Pay / Redeem) -->
  <div class="modal" id="purchaseModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3 id="purchaseTitle">Unlock Course</h3>
      <p id="purchaseDesc">This course is locked. Purchase to unlock, or redeem points if eligible.</p>
      <div id="redeemInfo" class="hero-meta"></div>
      <div class="modal-actions">
        <button class="btn success" id="btnPayNow">Pay Now</button>
        <button class="btn warn" id="btnRedeem">Redeem with Points</button>
        <button class="btn ghost" data-close="purchaseModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Not enough points -->
  <div class="modal" id="notEnoughModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3>Not enough points</h3>
      <p>You don’t have enough points to redeem this course.</p>
      <div class="modal-actions">
        <button class="btn primary" data-close="notEnoughModal">Okay</button>
      </div>
    </div>
  </div>

  <!-- Confirm Redeem (username + password) -->
  <div class="modal" id="redeemConfirmModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3>Confirm Redeem</h3>
      <p>Please confirm your account to redeem your points.</p>
      <div class="field">
        <label>Username <input type="text" id="redeemUser" autocomplete="username" /></label>
      </div>
      <div class="field">
        <label>Password <input type="password" id="redeemPass" autocomplete="current-password" /></label>
      </div>
      <div class="modal-actions">
        <button class="btn warn" id="confirmRedeem">Redeem</button>
        <button class="btn ghost" data-close="redeemConfirmModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirm Purchase (courses + live) -->
  <div class="modal" id="confirmPurchaseModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3 id="confirmPurchaseTitle">Confirm Purchase</h3>
      <p id="confirmPurchaseText">Proceed to payment?</p>
      <div class="modal-actions">
        <button class="btn success" id="proceedPayment">Proceed</button>
        <button class="btn ghost" data-close="confirmPurchaseModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Day Detail (calendar items for one day) -->
  <div class="modal" id="dayDetailModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-content">
      <h3 id="dayDetailTitle">Day Items</h3>
      <div id="dayDetailList" class="day-list"></div>
      <div class="modal-actions">
        <button class="btn primary" data-close="dayDetailModal">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== HOME LOGIC ===== -->
  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const store = {
      get(k, f){ try{const v=localStorage.getItem(k); return v?JSON.parse(v):f;}catch{return f} },
      set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    };
    const KEYS = {
      sub:'ao_isSubscriber',
      points:'ao_points',
      hist:'ao_history',               // [{ts,type,id,title,pointsDelta,extra}]
      purchased:'ao_purchasedCourses', // [courseId]  (also used for Foundations)
      daily:'ao_completedDailies',     // ["YYYY-MM-DD"]
      weekly:'ao_completedWeeklies',   // [{id:"W07", dateISO:"YYYY-MM-DD"}]
      payment:'ao_payment_success'     // {ts,type:"course"|"live", id, title}
    };
    let isSubscriber = !!store.get(KEYS.sub, false);
    let points = +store.get(KEYS.points, 0);
    let history = store.get(KEYS.hist, []);
    let purchased = store.get(KEYS.purchased, []);
    let dailyDone = store.get(KEYS.daily, []);
    let weeklyDone = store.get(KEYS.weekly, []);

    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const pad = n => String(n).padStart(2,'0');
    const fmtDate = d => `${dayNames[d.getDay()]} ${pad(d.getDate())}/${pad(d.getMonth()+1)}`;

    function paintTop(){ $('#pointsValue').textContent = points; $('#subState').textContent = isSubscriber?'On':'Off'; $('#toggleSub').setAttribute('aria-pressed', isSubscriber?'true':'false'); }
    paintTop();

    /* ===== Tabs ===== */
    const tabBtns = $$('.tab'); const panels = $$('.tab-panel');
    tabBtns.forEach(btn=>btn.addEventListener('click',()=>{
      tabBtns.forEach(b=>{const sel=b===btn; b.classList.toggle('is-active',sel); b.setAttribute('aria-selected', sel?'true':'false');});
      panels.forEach(p=>p.classList.remove('is-active'));
      const panel = $('#'+btn.getAttribute('aria-controls')); if(panel) panel.classList.add('is-active');
      window.scrollTo({top:0, behavior:'smooth'});
      if(btn.id==='tabbtn-achievements'){ renderAchievements(); }
      if(btn.id==='tabbtn-calendar'){ renderCalendar(); paintTallies(); }
    }));

    /* ===== Daily ===== */
    const today = new Date(); const isoToday = (new Date()).toISOString().slice(0,10);
    $('#dailyDate').textContent = fmtDate(today);
    function untilMidnight(d=new Date()){
      const n=new Date(d); const end=new Date(n); end.setDate(n.getDate()+1); end.setHours(0,0,0,0);
      const diff=end - n; const m=Math.floor(diff/60000); const h=Math.floor(m/60), mm=m%60;
      return `${h}h ${mm}m`;
    }
    function tickExpire(){ $('#dailyExpires').textContent = untilMidnight(); }
    tickExpire(); setInterval(tickExpire, 30000);

    function setDailyButtonState(){
      const btn = $('#btnDailyAction'); const hero = $('#dailyHero');
      const done = dailyDone.includes(isoToday);
      if(done){ btn.textContent='Undo'; btn.className='btn btn-undo'; hero.classList.add('is-complete'); }
      else { btn.textContent='Complete'; btn.className='btn btn-complete'; hero.classList.remove('is-complete'); }
    }
    setDailyButtonState();

    function addHistory(entry){ history.unshift({ts:Date.now(), ...entry}); store.set(KEYS.hist, history); }
    function addDayEventBar(cell, color){ const bar=document.createElement('div'); bar.className='bar '+color; cell.appendChild(bar); }

    $('#btnDailyAction').addEventListener('click', ()=>{
      const done = dailyDone.includes(isoToday);
      if(!done){
        dailyDone.push(isoToday); store.set(KEYS.daily, dailyDone);
        points += 1; store.set(KEYS.points, points); paintTop();
        addHistory({type:'daily', id:isoToday, title:'Daily Challenge', pointsDelta:+1});
        setDailyButtonState();
        alert('Daily marked complete (+1 point).');
      } else {
        // Undo only allowed for same-day
        dailyDone = dailyDone.filter(d=>d!==isoToday); store.set(KEYS.daily, dailyDone);
        points = Math.max(0, points-1); store.set(KEYS.points, points); paintTop();
        // Remove the most recent matching same-day daily event
        const i = history.findIndex(h => h.type==='daily' && new Date(h.ts).toDateString() === new Date().toDateString());
        if(i>-1){ history.splice(i,1); store.set(KEYS.hist, history); }
        setDailyButtonState();
        alert('Daily undone (−1 point).');
      }
    });

    /* ===== 52 Weekly Challenges ===== */
    const WEEKLY = [
      {id:'W01', title:'Gesture Lines', desc:'Loose lines, large arm movement.'},
      {id:'W02', title:'Negative Space', desc:'See shapes around the subject.'},
      {id:'W03', title:'Value Ladder', desc:'Five-step tonal control.'},
      {id:'W04', title:'Edges—Hard/Soft', desc:'Control transitions.'},
      {id:'W05', title:'Ink + Wash', desc:'Line then dilute wash.'},
      {id:'W06', title:'Contour & Blind', desc:'Trust the line, look more.'},
      {id:'W07', title:'Planes of the Head', desc:'Break forms into planes.'},
      {id:'W08', title:'Texture Hunt', desc:'Rubbings + drawn textures.'},
      {id:'W09', title:'Silhouette Power', desc:'Readability in outline.'},
      {id:'W10', title:'Warm/Cool Contrast', desc:'Temperature decisions.'},
      {id:'W11', title:'Mark Variety', desc:'Thick, thin, broken, dragged.'},
      {id:'W12', title:'Compositional Threes', desc:'Foreground/mid/background.'},
      {id:'W13', title:'Speed Studies', desc:'1–5 minute bursts.'},
      {id:'W14', title:'Cross-hatching', desc:'Controlled texture build.'},
      {id:'W15', title:'Ink Splashes', desc:'Directed spontaneity.'},
      {id:'W16', title:'Charcoal Tonals', desc:'Mass the shadows.'},
      {id:'W17', title:'Lost & Found Edges', desc:'Melt and sharpen selectively.'},
      {id:'W18', title:'Gesture Portrait', desc:'Energy over detail.'},
      {id:'W19', title:'Light Direction', desc:'Single source studies.'},
      {id:'W20', title:'Abstracted Forms', desc:'Simplify to shapes.'},
      {id:'W21', title:'Perspective Basics', desc:'1-point & 2-point.'},
      {id:'W22', title:'Figure Rhythm', desc:'S-curve, C-curve flow.'},
      {id:'W23', title:'Limited Palette', desc:'3 colours max.'},
      {id:'W24', title:'Big Brushes', desc:'Commit to bold passes.'},
      {id:'W25', title:'Smudge & Lift', desc:'Subtractive drawing.'},
      {id:'W26', title:'Line Hierarchy', desc:'Weight guides the eye.'},
      {id:'W27', title:'Edges with Water', desc:'Feathered dissolves.'},
      {id:'W28', title:'Thumbnails', desc:'Plan before render.'},
      {id:'W29', title:'Pattern & Repetition', desc:'Motifs unify.'},
      {id:'W30', title:'Proportion Check', desc:'Sight-size habits.'},
      {id:'W31', title:'Expressive Tools', desc:'Sticks, cards, rags.'},
      {id:'W32', title:'Colour Notes', desc:'Small patches first.'},
      {id:'W33', title:'Focal Point', desc:'Contrast and detail.'},
      {id:'W34', title:'Edges & Atmosphere', desc:'Depth via softness.'},
      {id:'W35', title:'Ink Portrait', desc:'Brush + splash accents.'},
      {id:'W36', title:'Value Composition', desc:'3-value design.'},
      {id:'W37', title:'Contour + Tone', desc:'Line then mass.'},
      {id:'W38', title:'Gesture Landscapes', desc:'Broad shapes quickly.'},
      {id:'W39', title:'Reflected Light', desc:'Turn the form.'},
      {id:'W40', title:'Textural Contrast', desc:'Smooth vs rough.'},
      {id:'W41', title:'Edges—Lost Foreground', desc:'Merge into background.'},
      {id:'W42', title:'Colour Harmony', desc:'Analogous harmony.'},
      {id:'W43', title:'Ink & Charcoal Mix', desc:'Wet over dry.'},
      {id:'W44', title:'Expressive Hands', desc:'Structure + gesture.'},
      {id:'W45', title:'Skies & Weather', desc:'Mood studies.'},
      {id:'W46', title:'Back-lighting', desc:'Rims and silhouettes.'},
      {id:'W47', title:'Fabric & Folds', desc:'Light logic.'},
      {id:'W48', title:'Architecture Lines', desc:'Plumb & level.'},
      {id:'W49', title:'Edge Priorities', desc:'Where to sharpen.'},
      {id:'W50', title:'Colour Accents', desc:'Small high-chroma hits.'},
      {id:'W51', title:'Gesture Animals', desc:'Capture movement.'},
      {id:'W52', title:'Best-of Remix', desc:'Combine 3 skills.'}
    ];

    function firstSundayOfYear(y){ const jan1=new Date(y,0,1); const dow=jan1.getDay(); const fs=new Date(y,0,1+((7-dow)%7)); fs.setHours(0,0,0,0); return fs; }
    function addWeeks(d,w){ const x=new Date(d); x.setDate(x.getDate()+w*7); return x; }
    function startOfSunday(d){ const x=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const dow=x.getDay(); x.setDate(x.getDate()-dow); x.setHours(0,0,0,0); return x; }
    function weekIndex(d){ const y=d.getFullYear(); const fs=firstSundayOfYear(y); const delta=d - fs; if(delta<0) return weekIndex(new Date(y-1,11,31)); const w=Math.floor(delta/(7*24*3600*1000)); return w % 52; }
    function fmtRange(s,e){ return `Starts ${pad(s.getDate())}/${pad(s.getMonth()+1)} • Expires ${pad(e.getDate())}/${pad(e.getMonth()+1)}`; }

    // Hidden index list (links to weekly-WNN.html placeholders)
    const idxUl = $('#weeklyIndex');
    WEEKLY.forEach(w=>{ const li=document.createElement('li'); const a=document.createElement('a'); a.href=`weekly-${w.id}.html`; a.textContent=`${w.id} — ${w.title}`; li.appendChild(a); idxUl.appendChild(li); });

    function paintWeekly(){
      const row = $('#weeklyRow'); row.innerHTML='';
      const base = startOfSunday(new Date());
      const sundays = [0,-1,-2].map(w=>addWeeks(base,w));
      sundays.forEach(s=>{
        const expiry = addWeeks(s,4); const expired = (new Date()) >= expiry;
        const idx = weekIndex(s); const def = WEEKLY[idx];
        const done = weeklyDone.some(x=>x.id===def.id);
        const locked = !isSubscriber;
        const card = document.createElement('article');
        card.className = `hero weekly ${expired?'is-expired':''} ${locked?'locked':''}`;
        card.dataset.weekId = def.id; card.dataset.startIso = s.toISOString(); card.dataset.expiryIso = expiry.toISOString();
        card.innerHTML = `
          <div class="hero-body">
            <h3 class="hero-title">${locked?'<svg class="padlock" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>':''}${def.title} ${done?'<span style="color:var(--green); font-weight:900;">✓</span>':''}</h3>
            <p class="hero-meta">${fmtRange(s,expiry)}</p>
            <p class="hero-desc">${def.desc}</p>
            <a class="btn primary btn-left btnStartWeekly" ${locked||expired?'aria-disabled="true" tabindex="-1"':''}
               href="${locked||expired?'#':`weekly-${def.id}.html`}" data-week="${def.id}">Start Challenge</a>
            <div class="hero-expiry">${expired?'Expired':'Active'}</div>
          </div>`;
        if(done) card.classList.add('is-complete');
        row.appendChild(card);
      });
      // If locked, Start link is inert (no popup)
      $$('.btnStartWeekly').forEach(a=>{
        a.addEventListener('click', (e)=>{ if(a.getAttribute('aria-disabled')==='true'){ e.preventDefault(); } });
      });
    }
    paintWeekly();

    // Completion API for weekly pages
    window.AO_markWeeklyComplete = function(weekId, title){
      const iso=(new Date()).toISOString().slice(0,10);
      if(!weeklyDone.some(w=>w.id===weekId)){
        weeklyDone.push({id:weekId, dateISO:iso}); store.set(KEYS.weekly, weeklyDone);
        points += 10; store.set(KEYS.points, points); paintTop();
        addHistory({type:'weekly', id:weekId, title, pointsDelta:+10});
        // Mark UI if card exists on current board
        const card = document.querySelector(`[data-week-id="${weekId}"]`);
        if(card){ card.classList.add('is-complete'); const t=card.querySelector('.hero-title'); if(t) t.insertAdjacentHTML('beforeend',' <span style="color:var(--green); font-weight:900;">✓</span>'); }
      }
    };

    /* ===== Subscriber toggle (weekly only) ===== */
    $('#toggleSub').addEventListener('click', ()=>{ isSubscriber=!isSubscriber; store.set(KEYS.sub,isSubscriber); paintTop(); paintWeekly(); });

    /* ===== Courses / Foundations: purchase or redeem ===== */
    function purchasedQ(id){ return purchased.includes(id); }
    function repaintCourseLocks(){
      $$('.course').forEach(card=>{
        const id=card.dataset.courseId; const locked=!purchasedQ(id);
        card.classList.toggle('locked', locked);
      });
    }
    repaintCourseLocks();

    let pending = null; // {kind:'course'|'live', id,title,type,days,redeem,link,theme}
    $$('.btnStartCourse').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const card = e.target.closest('.course');
        const id = card.dataset.courseId, type=card.dataset.courseType, days=+card.dataset.courseDays||1, redeem=+(card.dataset.redeem||0), link=card.dataset.link, theme=card.dataset.theme||'';
        const title = card.querySelector('.hero-title')?.textContent.replace(/^.*\]\s*/,'') || 'Course';
        if(purchasedQ(id)){
          // already unlocked → open + add span to calendar (visual booking window)
          openCourse(link, {type, days, title, theme});
          return;
        }
        pending = {kind:'course', id,title,type,days,redeem,link,theme};
        $('#purchaseTitle').textContent = `Unlock “${title}”`;
        $('#redeemInfo').textContent = redeem ? `You can redeem this course for ${redeem} points.` : 'This course cannot be redeemed with points.';
        const rb = $('#btnRedeem');
        rb.disabled = !redeem;
        openModal('purchaseModal');
      });
    });
    function openCourse(link, meta){
      // Add a span bar to calendar representing the run (1, 3 pink, 30 red)
      const color = meta.type==='3day' ? 'pink' : (meta.type==='30day' ? 'red' : 'blue');
      addHistory({type: meta.type==='3day' ? '3day-span' : (meta.type==='30day'?'30day-span':'1day'), id:meta.title, title:meta.title, pointsDelta:0, extra:{days:meta.days, ts:Date.now()}});
      window.location.href = link;
    }

    // Payment flow for courses
    $('#btnPayNow').addEventListener('click', ()=>{
      if(!pending) return;
      closeModal('purchaseModal');
      openConfirmPurchase(`Purchase “${pending.title}”`, 'Proceed to secure payment? (You’ll return here automatically after success.)', ()=>{
        // Write pending to storage for payment.html to read
        localStorage.setItem('ao_pending_payment', JSON.stringify({ts:Date.now(), type:'course', id:pending.id, title:pending.title}));
        window.location.href = 'payment.html';
      });
    });

    // Redeem flow
    $('#btnRedeem').addEventListener('click', ()=>{
      if(!pending) return;
      if(!pending.redeem){ return; }
      if(points < pending.redeem){ closeModal('purchaseModal'); openModal('notEnoughModal'); return; }
      closeModal('purchaseModal'); openModal('redeemConfirmModal');
    });
    $('#confirmRedeem').addEventListener('click', ()=>{
      const u=$('#redeemUser').value.trim(), p=$('#redeemPass').value.trim();
      if(!u || !p){ alert('Please enter username and password.'); return; }
      // Redeem
      const cost = pending.redeem||0;
      points -= cost; store.set(KEYS.points, points); paintTop();
      purchased.push(pending.id); store.set(KEYS.purchased, purchased);
      addHistory({type:'redeem', id:pending.id, title:pending.title, pointsDelta:-cost, extra:`redeemed ${cost} points`});
      closeModal('redeemConfirmModal'); repaintCourseLocks();
      // Immediately open course and add span
      openCourse(pending.link, pending);
    });

    // Listen for payment success from payment.html
    window.addEventListener('storage', (ev)=>{
      if(ev.key===KEYS.payment && ev.newValue){
        try{
          const payload = JSON.parse(ev.newValue);
          handlePaymentSuccess(payload);
        }catch{}
      }
    });
    function handlePaymentSuccess(payload){
      // payload: {ts,type:'course'|'live', id, title}
      if(!payload || !payload.type || !payload.id) return;
      if(payload.type==='course'){
        if(!purchased.includes(payload.id)){
          purchased.push(payload.id); store.set(KEYS.purchased, purchased); repaintCourseLocks();
          addHistory({type:'purchase', id:payload.id, title:payload.title, pointsDelta:0});
        }
      } else if(payload.type==='live'){
        // Add gold event
        addHistory({type:'live', id:payload.id, title:payload.title||'Live Demonstration Booking', pointsDelta:0});
      }
      // Clear flag (optional)
      localStorage.removeItem(KEYS.payment);
      alert('Payment successful — unlocked!');
    }

    /* ===== Live booking flow ===== */
    $$('.btnBookLive').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const card = e.target.closest('.hero'); const id = card.dataset.liveId; const title = card.querySelector('.hero-title')?.textContent || 'Live Demonstration';
        openConfirmPurchase(`Book “${title}”`, 'Proceed to secure payment?', ()=>{
          localStorage.setItem('ao_pending_payment', JSON.stringify({ts:Date.now(), type:'live', id, title}));
          window.location.href = 'payment.html';
        });
      });
    });

    function openConfirmPurchase(title, text, onProceed){
      $('#confirmPurchaseTitle').textContent = title;
      $('#confirmPurchaseText').textContent = text;
      openModal('confirmPurchaseModal');
      const proceed = $('#proceedPayment');
      const handler = ()=>{ closeModal('confirmPurchaseModal'); proceed.removeEventListener('click', handler); onProceed && onProceed(); };
      proceed.addEventListener('click', handler);
    }

    /* ===== Completion API for course/live pages ===== */
    window.AO_markCourseComplete = function(courseId, title){
      const card = document.querySelector(`[data-course-id="${courseId}"]`);
      if(card){ card.classList.add('is-complete'); const t=card.querySelector('.hero-title'); if(t && !t.textContent.includes('✓')) t.insertAdjacentHTML('beforeend',' <span style="color:var(--green); font-weight:900;">✓</span>'); }
      addHistory({type:'course-complete', id:courseId, title, pointsDelta:0});
    };
    window.AO_markLiveComplete = function(liveId, title){
      const card = document.querySelector(`[data-live-id="${liveId}"]`);
      if(card){ card.classList.add('is-complete'); const t=card.querySelector('.hero-title'); if(t && !t.textContent.includes('✓')) t.insertAdjacentHTML('beforeend',' <span style="color:var(--green); font-weight:900;">✓</span>'); }
      addHistory({type:'live-complete', id:liveId, title, pointsDelta:0});
    };

    /* ===== Achievements ===== */
    const PAGE=20; let page=0;
    function renderAchievements(){
      $('#achPoints').textContent = points;
      const b = $('#badgesGrid'); b.innerHTML='';
      weeklyDone.forEach(w=>{ const def=WEEKLY.find(d=>d.id===w.id); const el=document.createElement('span'); el.className='badge'; el.title=def?def.title:w.id; el.textContent=w.id; b.appendChild(el); });
      const now=new Date(); const monthDailies=dailyDone.filter(iso=>{const d=new Date(iso); return d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth();});
      $('#streakDisplay').textContent = `Daily completions this month: ${monthDailies.length}`;
      const ticks=$('#dailyTicks'); ticks.innerHTML=''; if(monthDailies.length){ const s=document.createElement('div'); s.textContent='✓ '.repeat(Math.min(monthDailies.length,200)); ticks.appendChild(s); }
      paintHistory();
    }
    function paintHistory(){
      const ul=$('#historyList'); ul.innerHTML='';
      const start=page*PAGE, end=start+PAGE;
      history.slice(start,end).forEach(h=>{
        const d=new Date(h.ts), when=`${pad(d.getDate())}/${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        const delta=h.pointsDelta>0?`(+${h.pointsDelta})`:(h.pointsDelta<0?`(${h.pointsDelta})`:'');
        const li=document.createElement('li'); li.className='history-item';
        li.innerHTML = `<strong>${h.type.toUpperCase()}</strong> — ${h.title||h.id} ${delta} <span class="hero-meta">• ${when}</span>`;
        ul.appendChild(li);
      });
    }
    $('#prevPage').addEventListener('click', ()=>{ if(page>0){ page--; paintHistory(); }});
    $('#nextPage').addEventListener('click', ()=>{ if((page+1)*PAGE<history.length){ page++; paintHistory(); }});

    /* ===== Calendar ===== */
    let calMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    function renderCalendar(){
      const y=calMonth.getFullYear(), m=calMonth.getMonth();
      $('#calTitle').textContent = `${calMonth.toLocaleString(undefined,{month:'long'})} ${y}`;
      const first = new Date(y,m,1); const start = new Date(first); start.setDate(1-first.getDay());
      const grid=$('#calGrid'); grid.innerHTML='';

      const counts = {daily:0, weekly:0, '3day':0, '30day':0, live:0};

      for(let i=0;i<42;i++){
        const d=new Date(start); d.setDate(start.getDate()+i);
        const cell=document.createElement('div'); cell.className='cal-cell';
        cell.dataset.iso = d.toISOString().slice(0,10);
        cell.innerHTML=`<div class="cal-date">${d.getDate()}</div>`;

        // Collect per-day discrete events
        const dayEvents = history.filter(h=> {
          const ht=new Date(h.ts);
          return ht.getFullYear()===d.getFullYear() && ht.getMonth()===d.getMonth() && ht.getDate()===d.getDate() &&
                 (h.type==='daily' || h.type==='weekly' || h.type==='live' || h.type==='purchase' || h.type==='redeem' || h.type==='course-complete' || h.type==='live-complete');
        });

        // Show up to 3 bars
        const colorFor = (t)=> t==='daily'?'blue' : t==='weekly'?'green' : t==='live'?'gold' : (t==='course-complete'?'green' : 'blue');
        dayEvents.slice(0,3).forEach(ev=>{ addDayEventBar(cell, colorFor(ev.type)); });
        if(dayEvents.length>3){ const keb=document.createElement('div'); keb.className='kebab'; cell.appendChild(keb); }

        // Spans (weekly/3day/30day)
        history.filter(h=>h.type.endsWith('-span')).forEach(h=>{
          const meta=h.extra||{}; const startTs=meta.ts||h.ts; const sD=new Date(startTs);
          const days=meta.days|| (h.type.startsWith('3day')?3 : h.type.startsWith('30day')?30 : 7);
          const spanStart=new Date(sD.getFullYear(), sD.getMonth(), sD.getDate());
          const spanEnd=new Date(spanStart); spanEnd.setDate(spanEnd.getDate()+days-1);
          if(d>=spanStart && d<=spanEnd){
            const bar=document.createElement('div'); bar.className='span ' + (
              h.type.startsWith('weekly')?'green' : h.type.startsWith('3day')?'pink' : 'red'
            );
            cell.appendChild(bar);
            // increment counts once per starting day to avoid inflation
            if(d.getTime()===spanStart.getTime()){
              if(h.type.startsWith('3day')) counts['3day']++;
              if(h.type.startsWith('30day')) counts['30day']++;
              if(h.type.startsWith('weekly')) counts['weekly']++;
            }
          }
        });

        // Count discrete events
        dayEvents.forEach(ev=>{
          if(ev.type==='daily') counts.daily++;
          if(ev.type==='weekly') counts.weekly++;
          if(ev.type==='live') counts.live++;
        });

        // Day click → detail modal
        cell.addEventListener('click', ()=> openDayDetail(d));
        grid.appendChild(cell);
      }

      // Paint tallies
      $('#tallyDaily').textContent = counts.daily;
      $('#tallyWeekly').textContent = counts.weekly;
      $('#tally3d').textContent = counts['3day'];
      $('#tally30d').textContent = counts['30day'];
      $('#tallyLive').textContent = counts.live;
    }
    $('#calPrev').addEventListener('click', ()=>{ calMonth.setMonth(calMonth.getMonth()-1); renderCalendar(); });
    $('#calNext').addEventListener('click', ()=>{ calMonth.setMonth(calMonth.getMonth()+1); renderCalendar(); });

    function paintTallies(){
      const box = $('#tallyLists'); box.style.display='none'; box.innerHTML='';
      $$('.tally').forEach(t=>t.onclick=()=>{
        const type=t.dataset.tally; box.style.display='block'; box.innerHTML='';
        const mapType = {
          daily: h=>h.type==='daily',
          weekly: h=>h.type==='weekly' || h.type==='weekly-span',
          '3day': h=>h.type.startsWith('3day'),
          '30day': h=>h.type.startsWith('30day'),
          live: h=>h.type==='live' || h.type==='live-complete'
        };
        history.filter(mapType[type]).forEach(h=>{
          const d=new Date(h.ts);
          const row=document.createElement('div'); row.className='history-item';
          row.textContent = `${h.title||h.id} • ${pad(d.getDate())}/${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
          box.appendChild(row);
        });
      });
    }

    function openDayDetail(dateObj){
      const iso = dateObj.toISOString().slice(0,10);
      $('#dayDetailTitle').textContent = `${pad(dateObj.getDate())}/${pad(dateObj.getMonth()+1)}/${dateObj.getFullYear()}`;
      const list=$('#dayDetailList'); list.innerHTML='';
      const items = history.filter(h=>{const d=new Date(h.ts); return d.toISOString().slice(0,10)===iso;});
      if(items.length===0){ list.textContent='No items.'; }
      else {
        items.forEach(h=>{ const row=document.createElement('div'); row.className='history-item'; row.textContent = `${h.type.toUpperCase()} — ${h.title||h.id}`; list.appendChild(row); });
      }
      openModal('dayDetailModal');
    }

    /* ===== Modals helpers ===== */
    function openModal(id){ const m=document.getElementById(id); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } }
    function closeModal(id){ const m=document.getElementById(id); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } }
    $$('[data-close]').forEach(b=>b.addEventListener('click', e=>closeModal(e.target.getAttribute('data-close'))));
    ['purchaseModal','notEnoughModal','redeemConfirmModal','confirmPurchaseModal','dayDetailModal'].forEach(mid=>{
      const m=document.getElementById(mid); if(!m) return;
      m.addEventListener('click', e=>{ if(e.target===m) closeModal(mid); });
    });

    /* ===== Initial paints ===== */
    renderAchievements();
    renderCalendar();

    // Ensure daily “Undo” resets at midnight automatically
    function midnightReset(){
      const now=new Date(); const next=new Date(now); next.setDate(now.getDate()+1); next.setHours(0,0,0,200); // a hair after midnight
      setTimeout(()=>{ setDailyButtonState(); renderCalendar(); midnightReset(); }, next-now);
    }
    midnightReset();
  })();
  </script>
</body>
</html>